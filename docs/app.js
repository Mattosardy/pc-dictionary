/* Diccionario de Reparación — TelecomT3 (versión final completa) */
const V=document.getElementById('view'),Q=document.getElementById('q'),BTN_HOME=document.getElementById('btn-home'),BTN_ADMIN=document.getElementById('btn-admin'),F_WRAPPER=document.getElementById('filters'),F_NIVEL=document.getElementById('f-nivel'),F_RIESGO=document.getElementById('f-riesgo');
let DB={departments:[],entries:[]};
function hydrateDB(){try{if(window&&window.DB&&Array.isArray(window.DB.departments)){DB=window.DB;return!0}}catch(e){}return!1}
function ensureDBThen(fn){if(hydrateDB()){fn();return}let tries=0;const t=setInterval(()=>{if(hydrateDB()||++tries>40){clearInterval(t);fn()}},50)}
const ICONS={almacenamiento:"💽",ram:"🧠",cpu:"🧩",gpu:"🎮",motherboard:"🧷",psu:"🔌",cooling:"🌀",network:"🌐",os:"🪟",security:"🛡️"},QUICK=[{label:"DiskPart clean + GPT",id:"almacenamiento-diskpart-clean-gpt"},{label:"Reset Winsock/DNS",id:"network-stack-reset-dns"},{label:"DDU (limpieza drivers GPU)",id:"gpu-ddu-driver-clean"},{label:"TRIM SSD",id:"almacenamiento-trim-ssd"},{label:"Reparar BCD (bootrec)",id:"os-bootrec-reparar-arranque"},{label:"Update atascado",id:"os-wupdate-reset-componentes"}],CHIPS=["diskpart","ram","bios","drivers","gpu","dns","sfc","temperatura","backup"];
function route(){const h=location.hash.slice(1);if(!h)return renderHome();const[k,id]=h.split("/");if("dept"===k)return renderDept(id);if("entry"===k)return renderEntry(id);renderHome()}
function renderHome(){F_WRAPPER&&(F_WRAPPER.style.display="none");const d=DB.departments||[],t=(DB.entries||[]).length,h=`<div class="hero"><h1>Diccionario de Reparación — <span style="color:#2bb673">TelecomT3</span></h1><div class="kpis"><div class="kpi"><b>${d.length}</b> departamentos</div><div class="kpi"><b>${t}</b> playbooks</div><div class="kpi"><b>Offline</b> ready</div></div><div class="chips">${CHIPS.map(e=>`<span class="chip" onclick="setQuery('${e}')">#${e}</span>`).join("")}</div></div><div class="grid">${d.map(e=>`<div class="card"><div style="font-weight:700;margin-bottom:8px">${ICONS[e.id]||""} ${e.nombre}</div><a class="btn" href="#dept/${e.id}">Abrir</a></div>`).join("")}</div><div class="card" style="margin:16px"><h3>Accesos rápidos</h3>${QUICK.map(e=>`<a class="tool-btn" href="#entry/${e.id}">${e.label}</a>`).join("")}</div>`;V.innerHTML=h}
function setQuery(e){Q.value=e;Q.dispatchEvent(new Event("input"))}
function renderDept(e){const t=(DB.departments||[]).find(t=>t.id===e),n=(DB.entries||[]).filter(t=>t.departamento_id===e);F_WRAPPER&&(F_WRAPPER.style.display="flex"),F_NIVEL.value=F_NIVEL.value||"",F_RIESGO.value=F_RIESGO.value||"";function r(){let e=n.slice(),r=(F_NIVEL?.value||"").trim().toLowerCase(),a=(F_RIESGO?.value||"").trim().toLowerCase();r&&(e=e.filter(e=>String(e.nivel||"").toLowerCase().includes(r))),a&&(e=e.filter(e=>String(e.riesgo||"").toLowerCase().includes(a))),V.innerHTML=`<div class="card" style="margin:16px"><div style="display:flex;justify-content:space-between;align-items:center"><div><b>${t?t.nombre:e}</b> <small>(${e.length}/${n.length})</small></div><a class="btn" href="#">Volver</a></div></div><div class="list">${e.map(e=>`<div class="entry"><div style="display:flex;justify-content:space-between;gap:8px;align-items:center"><div><b>${e.problema}</b> <small>[${e.nivel} • ${e.riesgo}]</small></div><a class="btn" href="#entry/${e.id}">Ver</a></div><small>${e.causa}</small></div>`).join("")}</div>`}F_NIVEL.onchange=F_RIESGO.onchange=r,r()}
function renderEntry(e){F_WRAPPER&&(F_WRAPPER.style.display="none");const t=(DB.entries||[]).find(t=>t.id===e);if(!t)return void(V.innerHTML='<div class="card" style="margin:16px">No encontrado</div>');const n=t.imagenes&&t.imagenes.length?`<div class="gallery">${t.imagenes.map(e=>`<img src="${e}" loading="lazy" alt="captura" onclick="openLB('${e}')">`).join("")}</div>`:"",r=t.herramientas&&t.herramientas.length?`<div class="tools">${t.herramientas.map(e=>`<a class="tool-btn" href="${e.url}" target="_blank" rel="noopener">${e.nombre}</a>`).join("")}</div>`:"";V.innerHTML=`<div class="card" style="margin:16px"><a class="btn" href="#dept/${t.departamento_id}">← Volver</a><h3 style="margin:12px 0 6px 0">${t.problema}</h3><small>${t.departamento} • ${t.nivel} • ${t.riesgo} • ${t.tiempo_min} min</small>${n}<p style="margin-top:8px"><b>Causa probable:</b> ${t.causa}</p><div><b>Solución directa:</b><pre>${(t.solucion||[]).join("\\n")}</pre></div>${t.verificacion?.length?`<div><b>Verificación:</b><pre>${t.verificacion.join("\\n")}</pre></div>`:""}${t.comandos?.length?`<div><b>Comandos:</b><pre>${t.comandos.join("\\n")}</pre></div>`:""}${r?`<div style="margin-top:6px"><b>Herramientas gratuitas y seguras:</b>${r}</div>`:""}</div>`}
function openLB(e){const t=document.createElement("div");t.className="lb-mask",t.innerHTML=`<img class="lb-img" src="${e}" alt="preview">`,t.addEventListener("click",()=>document.body.removeChild(t)),document.body.appendChild(t)}
Q.addEventListener("input",()=>{const e=Q.value.trim().toLowerCase();if(!e)return route();const t=(DB.entries||[]).filter(t=>{const n=(t.herramientas||[]).map(e=>e.nombre).join(" ");return(t.problema||"").toLowerCase().includes(e)||(t.causa||"").toLowerCase().includes(e)||(t.tags||[]).join(" ").toLowerCase().includes(e)||(t.solucion||[]).join(" ").toLowerCase().includes(e)||n.toLowerCase().includes(e)});V.innerHTML=`<div class="card" style="margin:16px"><div><b>Resultados</b> <small>(${t.length})</small></div></div><div class="list">${t.map(e=>`<div class="entry"><div style="display:flex;justify-content:space-between;align-items:center"><div><b>${e.problema}</b> <small>[${e.departamento}]</small></div><a class="btn" href="#entry/${e.id}">Ver</a></div><small>${e.causa}</small></div>`).join("")}</div>`});
BTN_HOME?.addEventListener("click",e=>{e.preventDefault(),location.hash="",route()});
window.addEventListener("hashchange",()=>ensureDBThen(route));
window.addEventListener("load",()=>ensureDBThen(route));
